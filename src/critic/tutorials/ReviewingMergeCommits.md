# Reviewing Merge Commits

Reviewing merge commits is not always easy, and the diffs that Critic displays for them are not always easy to understand.

_First of all_: It may not be necessary to carefully review a merge commit at all! Sometimes it's simpler and better to just review the full patch (comparing the tip of the review branch to its upstream branch) than to review each and every commit, especially if there are merge commits.

If you do decide to review a merge commit in detail, here is how Critic displays a merge commit:

## Changes Relative Parents

Normally, a commit is displayed simply as a comparison/diff against its parent commit. A merge commit is just a commit with multiple parent commits, but displaying it as a simple comparison to either one, or all, of its parent commits typically does not make sense. If, for instance, `master` is merged back into a review branch, comparing the merge commit to its parents will either display all changes so far on the review branch (squashed into a single diff) or all changes on `master` between the original branch point and the merged in commit (again squashed into a single diff). Neither one will be useful to review in full. In particular, neither commit will be helpful in determining whether something went wrong in the merge, which is the purpose of reviewing the merge commit in the first place.

The interesting case when comparing a merge commit to its parents is when a file was modified on both/multiple sides of the merge. This is the case where a conflict may have needed to be resolved, for instance, if such changes were to overlap or be very close to each other. (If they are far apart, Git will of course have merged the changes without conflicts.)

For each such file, Critic will display the diff between the merge commit and each of the parents that introduced changes to it. The diff in each file is filtered down to only contain changes that overlap with, or are sufficiently adjacent to, changes introduced by some other parent. Typically, those changes introduced by some other parent will in turn be included in the diff between the merge commit and that parent.

It's usually only necessary to make a cursory examination of the displayed changes to make sure they all look reasonable.

## Merge Replay

In addition to the filtered comparison/diff described above, Critic also displays merges using a radically different strategy: by "replaying" the merge and comparing the result to the actual merge commit.

Critic "replays" a merge by checking out the first parent in a temporary work tree, and then executing `git merge <other parents>` in that tree. Afterwards, regardless of whether the merge succeeded or produced conflicts, the state of the tree is committed. (Including any conflict markers that Git might have added to files.)

The comparison/diff between this replayed merge and the real merge commit will effectively include two types of changes:

1. Conflict resolutions, with the conflict blocks/markers generated by Git on the left-hand side, and the code with those conflicts resolved on the right-hand side, and

2. Any other changes that were made to the code during the merging, that were not directly related to resolving merge conflicts.

The former is often a helpful way to display how conflicts were solved, and the latter is sometimes the only way to notice such unrelated changes, as both Critic's "changes relative parents" display and Git's "combined diff" focus solely on overlapping/adjacent changes.

## Final Words

Critic uses two parallel strategies to display merge commits. Sometimes one works better, at other times the other does. If one works well, there is no requirement to even look at the other.

All individual changes Critic displays need to be ticked off as "reviewed", as always, but do not hesitate to just use the "Mark all as reviewed" facility, after reviewing anything that seems relevant.
